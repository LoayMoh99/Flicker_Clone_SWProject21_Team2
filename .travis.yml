sudo: required
language: generic

services:
  - docker

before_install:
  # - openssl aes-256-cbc -K $encrypted_db2095f63ba3_key -iv $encrypted_db2095f63ba3_iv -in .travis/deploy_rsa.enc -out .travis/deploy_rsa -d
  # - eval "$(ssh-agent -s)"
  # - cp .travis/deploy_rsa ~/.ssh/deploy_rsa
  # - chmod 600 ~/.ssh/deploy_rsa
  # - ssh-add ~/.ssh/deploy_rsa
  # Build Docker image for testing:
  - echo Build front and api docker images for testing..
  - docker build -t loaymoh99/react-test -f ./front/Dockerfile.dev ./front
  - docker build -t loaymoh99/nodejs-test -f ./api/Dockerfile.dev ./api

script:
  # Run tests with built Docker images:
  - echo Run react tests..
  - docker run -e CI=true loaymoh99/react-test
  - echo Run nodejs tests...
  # - docker run -e CI=true loaymoh99/nodejs-test

after_success:
  - echo Building the production Docker image..
  - docker build -t loaymoh99/dkr-dropoids-front ./front
  - docker build -t loaymoh99/dkr-dropoids-nginx ./nginx
  - docker build -t loaymoh99/dkr-dropoids-api ./api
  # Log in to the docker CLI: loaymoh99/dkr-dropoids-front:$(date +%s)
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
  # Take those images and push them to docker hubgit push -u origin main:
  - echo Pushing the Docker images..
  - docker push loaymoh99/dkr-dropoids-front
  - docker push loaymoh99/dkr-dropoids-nginx
  - docker push loaymoh99/dkr-dropoids-api

after_success:
  # Make sure that all images are healthy:
  - echo Building the production Docker image..
  - docker build -t loaymoh99/dkr-dropoids-front ./front
  - docker build -t loaymoh99/dkr-dropoids-nginx ./nginx
  - docker build -t loaymoh99/dkr-dropoids-api ./api


deploy:
  provider: script
  skip_cleanup: true
  script: bash ./deploy.sh
  on:
    branch: main

# notifications:  
#   email:
#     recipients:
#       - loaymohamed1999@gmail.com
#     on_success: never # default: change
#     on_failure: always # default: always
